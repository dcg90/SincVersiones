async function loadUnsyncedProducts(n){if(n!=null){const i=providersSelect.val(),r=brandsSelect.val(),t=new URL("product/unsyncedProducts",window.location.origin);t.searchParams.append("providerId",i);t.searchParams.append("brandId",r);t.searchParams.append("page",n);t.searchParams.append("limit",_searchSession.itemsPerPage);t.searchParams.append("skuOrName",$('#unsynced-search input[name="sku-or-name"]').val());t.searchParams.append("withStock",_searchSession.withStock);try{unsyncedSpinner.fadeIn();const i=await $.get(t.toString());$("#unsynced-products").hide().html(i);const r=+$("#unsynced-total-pages").data("total-pages")||1;$("#unsynced-products-pagination").bootpag({total:r,page:n,maxVisible:5});$("#unsynced-products").fadeIn()}catch(u){displayErrorAlert("Ha ocurrido un error al intentar obtener productos no sincronizados.")}finally{unsyncedSpinner.fadeOut()}}}async function loadSyncedProducts(n){if(n!=null){const t=new URL("product/syncedProducts",window.location.origin);t.searchParams.append("page",n.toString());t.searchParams.append("limit",_searchSession.itemsPerPage);t.searchParams.append("skuOrName",$('#synced-search input[name="sku-or-name"]').val());t.searchParams.append("brandIds",$('#synced-search input[name="brands"]').val());try{syncedSpinner.fadeIn();const i=await $.get(t.toString());$("#synced-products").hide().html(i);const r=+$("#synced-total-pages").data("total-pages")||1;$("#synced-products-pagination").bootpag({total:r,page:n,maxVisible:5});$("#synced-products").fadeIn()}catch(i){displayErrorAlert("Ocurri√≥ un error al cargar los productos.")}finally{syncedSpinner.fadeOut()}}}async function loadBrands(){const t=providersSelect.val(),n=new URL("provider/brands",window.location.origin);n.searchParams.append("providerId",t);try{unsyncedSpinner.fadeIn();const t=await $.get(n.toString());t!==""&&brandsSelect.html(t)}catch(i){}finally{unsyncedSpinner.fadeOut()}}async function syncProduct(){const i=$("#syncProductModal"),n=i.find(".modal-body"),r=n.find('input[name="providerProductId"]').val(),t=n.find('input[name="productName"]').val(),u=parseInt(n.find('input[name="margin"]').val()),f=providersSelect.val().toString(),e=n.find('input[name="productSku"]').val(),o=JSON.stringify({providerProductId:r,providerId:f,name:t,margin:u,sku:e}),s=new URL("product/syncProduct",window.location.origin);try{unsyncedSpinner.fadeIn();i.modal("hide");await $.post({url:s.toString(),data:o,contentType:"application/json; charset=utf-8"});displaySuccessAlert(`El producto <strong>${t}</strong> ha sido sincronizado correctamente.`);loadUnsyncedProducts(getSyncActivePage())}catch(h){displayErrorAlert(`El producto <strong>${t}</strong> no ha sido sincronizado.`)}finally{unsyncedSpinner.fadeOut()}}function getSyncActivePage(){return parseInt($("#synced-products-pagination li.active").attr("data-lp"))}function getUnsyncActivePage(){return parseInt($("#unsynced-products-pagination li.active").attr("data-lp"))}function initItemsPerPage(){function n(){$("#items-per-page li").removeClass("active");$(`#items-per-page li[data-ipp="${_searchSession.itemsPerPage}"]`).addClass("active")}n();$("#items-per-page li").click(function(){$(this).data("ipp")!==_searchSession.itemsPerPage&&(_searchSession.itemsPerPage=$(this).data("ipp"),n(),loadSyncedProducts(1),loadUnsyncedProducts(1))})}function initPagination(){const n=$.fn.bootpag;$.fn.bootpag=function(t){const i=n.bind($(this))(t);return $("ul.pagination.bootpag li>a").addClass("page-link"),i};$("#synced-products-pagination").bootpag({total:0,page:_searchSession.sPage,maxVisible:5,leaps:!0}).on("page",async function(n,t){await loadSyncedProducts(t)});$("#unsynced-products-pagination").bootpag({total:0,page:_searchSession.uPage,maxVisible:5,leaps:!0}).on("page",async function(n,t){await loadUnsyncedProducts(t)})}function initUnsyncTabSelects(){providersSelect.change(async function(){await loadBrands();await loadUnsyncedProducts(_searchSession.uPage);$("#unsynced-products-pagination").bootpag({page:_searchSession.uPage})});brandsSelect.change(async function(){await loadUnsyncedProducts(1);$("#unsynced-products-pagination").bootpag({page:1})})}function initSyncProductModal(){$("#sync-product").click(syncProduct);$("#syncProductModal").on("show.bs.modal",function(n){const t=$(n.relatedTarget),f=t.data("provider-product-id"),e=t.data("provider-product-desc"),r=t.data("provider-product-brand").toLowerCase(),u=t.data("provider-product-sku"),o=`${r[0].toUpperCase()}${r.substring(1)} ${u}`;var i=$(this);i.find('.modal-body input[name="providerProductId"]').val(f);i.find('.modal-body input[name="productDesc"]').val(e);i.find('.modal-body input[name="productSku"]').val(u);i.find('.modal-body input[name="productName"]').val(o)})}async function loadSearchSession(){let t=null;try{const n=new URL("product/prefetchBrands",window.location.origin);t=await $.get(n.toString())}catch(i){displayErrorAlert("No se han podido cargar las marcas de los productos.")}let n=JSON.parse(sessionStorage.getItem("searchSession"));n==null&&(n={itemsPerPage:10,sPage:1,sSkuOrName:null,sBrands:null,uPage:1,uSkuOrName:null,activeTab:"synced-tab",providerId:null,providerBrandId:null,withStock:!0});Object.assign(n,{prefetchedBrands:t||n.brands||[]});window._searchSession=n}function saveSearchSession(){Object.assign(_searchSession,{sPage:getSyncActivePage(),sSkuOrName:$('#synced-search input[name="sku-or-name"]').val(),sBrands:$('#synced-search input[name="brands"]').val(),uPage:getUnsyncActivePage(),uSkuOrName:$('#unsynced-search input[name="sku-or-name"]').val(),activeTab:$("#product-tabs > li > a.active").attr("id"),providerId:$("#unsynced-providers").val(),providerBrandId:$("#unsynced-brands").val()});sessionStorage.setItem("searchSession",JSON.stringify(_searchSession))}function initFilterInputs(){const n=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("name"),queryTokenizer:Bloodhound.tokenizers.whitespace,local:_searchSession.prefetchedBrands});n.initialize();$('#synced-search input[name="brands"]').val(_searchSession.sBrands).tagsinput({itemValue:"id",itemText:"name",typeaheadjs:{name:"brands",displayKey:"name",source:n.ttAdapter()}});initTypeaheadInputs()}function initTypeaheadInputs(){const n=12;for(let t of[!0,!1]){const i=new URL("product/skuOrNameProductSuggestions",window.location.origin);i.searchParams.append("syncedProducts",t.toString());i.searchParams.append("suggestionsLimit",n.toString());const r=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("value"),queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{url:i.toString()+"&skuOrName=%skuOrName",wildcard:"%skuOrName",replace:function(n,i){t||(i+="&withStock="+_searchSession.withStock);let r=n.replace("%skuOrName",i);if(!t){const n=new URL(r);n.searchParams.append("providerId",providersSelect.val());n.searchParams.append("brandId",brandsSelect.val());r=n.toString()}return r}}});r.initialize();const u=t?"synced-search":"unsynced-search",f=t?_searchSession.sSkuOrName:_searchSession.uSkuOrName;$(`#${u} input[name="sku-or-name"]`).val(f).typeahead({highlight:!0},{source:r.ttAdapter(),limit:n,displayKey:"value",valueKey:"value"});$(`#${u} button.btn-search-products`).click(function(){t?loadSyncedProducts(1):loadUnsyncedProducts(1)})}}(function(n){"use strict";function i(t,i){this.itemsArray=[];this.$element=n(t);this.$element.hide();this.isSelect=t.tagName==="SELECT";this.multiple=this.isSelect&&t.hasAttribute("multiple");this.objectItems=i&&i.itemValue;this.placeholderText=t.hasAttribute("placeholder")?this.$element.attr("placeholder"):"";this.inputSize=Math.max(1,this.placeholderText.length);this.$container=n('<div class="bootstrap-tagsinput"><\/div>');this.$input=n('<input type="text" placeholder="'+this.placeholderText+'"/>').appendTo(this.$container);this.$element.before(this.$container);this.build(i)}function u(n,t){if(typeof n[t]!="function"){var i=n[t];n[t]=function(n){return n[i]}}}function f(n,t){if(typeof n[t]!="function"){var i=n[t];n[t]=function(){return i}}}function t(n){return n?e.text(n).html():""}function o(n){var t=0,i;return document.selection?(n.focus(),i=document.selection.createRange(),i.moveStart("character",-n.value.length),t=i.text.length):(n.selectionStart||n.selectionStart=="0")&&(t=n.selectionStart),t}function s(t,i){var r=!1;return n.each(i,function(n,i){if(typeof i=="number"&&t.which===i)return r=!0,!1;if(t.which===i.which){var u=!i.hasOwnProperty("altKey")||t.altKey===i.altKey,f=!i.hasOwnProperty("shiftKey")||t.shiftKey===i.shiftKey,e=!i.hasOwnProperty("ctrlKey")||t.ctrlKey===i.ctrlKey;if(u&&f&&e)return r=!0,!1}}),r}var r={tagClass:function(){return"label label-info"},itemValue:function(n){return n?n.toString():n},itemText:function(n){return this.itemValue(n)},itemTitle:function(){return null},freeInput:!0,addOnBlur:!0,maxTags:undefined,maxChars:undefined,confirmKeys:[13,44],delimiter:",",delimiterRegex:null,cancelConfirmKeysOnEmpty:!0,onTagExists:function(n,t){t.hide().fadeIn()},trimValue:!1,allowDuplicates:!1},e;i.prototype={constructor:i,add:function(i,r,u){var f=this,a,e,o,w,l,s,h;if((!f.options.maxTags||!(f.itemsArray.length>=f.options.maxTags))&&(i===!1||i)){if(typeof i=="string"&&f.options.trimValue&&(i=n.trim(i)),typeof i=="object"&&!f.objectItems)throw"Can't add objects when itemValue option is not set";if(!i.toString().match(/^\s*$/)){if(f.isSelect&&!f.multiple&&f.itemsArray.length>0&&f.remove(f.itemsArray[0]),typeof i=="string"&&this.$element[0].tagName==="INPUT"&&(a=f.options.delimiterRegex?f.options.delimiterRegex:f.options.delimiter,e=i.split(a),e.length>1)){for(o=0;o<e.length;o++)this.add(e[o],!0);r||f.pushVal();return}var c=f.options.itemValue(i),v=f.options.itemText(i),b=f.options.tagClass(i),y=f.options.itemTitle(i),p=n.grep(f.itemsArray,function(n){return f.options.itemValue(n)===c})[0];if(p&&!f.options.allowDuplicates){if(f.options.onTagExists){w=n(".tag",f.$container).filter(function(){return n(this).data("item")===p});f.options.onTagExists(i,w)}return}f.items().toString().length+i.length+1>f.options.maxInputLength||(l=n.Event("beforeItemAdd",{item:i,cancel:!1,options:u}),f.$element.trigger(l),l.cancel)||(f.itemsArray.push(i),s=n('<span class="tag '+t(b)+(y!==null?'" title="'+y:"")+'">'+t(v)+'<span data-role="remove"><\/span><\/span>'),s.data("item",i),f.findInputWrapper().before(s),s.after(" "),f.isSelect&&!n('option[value="'+encodeURIComponent(c)+'"]',f.$element)[0]&&(h=n("<option selected>"+t(v)+"<\/option>"),h.data("item",i),h.attr("value",c),f.$element.append(h)),r||f.pushVal(),(f.options.maxTags===f.itemsArray.length||f.items().toString().length===f.options.maxInputLength)&&f.$container.addClass("bootstrap-tagsinput-max"),f.$element.trigger(n.Event("itemAdded",{item:i,options:u})))}}},remove:function(t,i,r){var u=this,f;if(u.objectItems&&(t=typeof t=="object"?n.grep(u.itemsArray,function(n){return u.options.itemValue(n)==u.options.itemValue(t)}):n.grep(u.itemsArray,function(n){return u.options.itemValue(n)==t}),t=t[t.length-1]),t){if(f=n.Event("beforeItemRemove",{item:t,cancel:!1,options:r}),u.$element.trigger(f),f.cancel)return;n(".tag",u.$container).filter(function(){return n(this).data("item")===t}).remove();n("option",u.$element).filter(function(){return n(this).data("item")===t}).remove();n.inArray(t,u.itemsArray)!==-1&&u.itemsArray.splice(n.inArray(t,u.itemsArray),1)}i||u.pushVal();u.options.maxTags>u.itemsArray.length&&u.$container.removeClass("bootstrap-tagsinput-max");u.$element.trigger(n.Event("itemRemoved",{item:t,options:r}))},removeAll:function(){var t=this;for(n(".tag",t.$container).remove(),n("option",t.$element).remove();t.itemsArray.length>0;)t.itemsArray.pop();t.pushVal()},refresh:function(){var i=this;n(".tag",i.$container).each(function(){var r=n(this),u=r.data("item"),e=i.options.itemValue(u),o=i.options.itemText(u),s=i.options.tagClass(u),f;r.attr("class",null);r.addClass("tag "+t(s));r.contents().filter(function(){return this.nodeType==3})[0].nodeValue=t(o);i.isSelect&&(f=n("option",i.$element).filter(function(){return n(this).data("item")===u}),f.attr("value",e))})},items:function(){return this.itemsArray},pushVal:function(){var t=this,i=n.map(t.items(),function(n){return t.options.itemValue(n).toString()});t.$element.val(i,!0).trigger("change")},build:function(t){var i=this,h;if(i.options=n.extend({},r,t),i.objectItems&&(i.options.freeInput=!1),u(i.options,"itemValue"),u(i.options,"itemText"),f(i.options,"tagClass"),i.options.typeahead&&(h=i.options.typeahead||{},f(h,"source"),i.$input.typeahead(n.extend({},h,{source:function(t,r){function f(n){for(var u,f=[],t=0;t<n.length;t++)u=i.options.itemText(n[t]),e[u]=n[t],f.push(u);r(f)}this.map={};var e=this.map,u=h.source(t);n.isFunction(u.success)?u.success(f):n.isFunction(u.then)?u.then(f):n.when(u).then(f)},updater:function(n){return i.add(this.map[n]),this.map[n]},matcher:function(n){return n.toLowerCase().indexOf(this.query.trim().toLowerCase())!==-1},sorter:function(n){return n.sort()},highlighter:function(n){var t=new RegExp("("+this.query+")","gi");return n.replace(t,"<strong>$1<\/strong>")}}))),i.options.typeaheadjs){var l=null,e={},c=i.options.typeaheadjs;n.isArray(c)?(l=c[0],e=c[1]):e=c;i.$input.typeahead(l,e).on("typeahead:selected",n.proxy(function(n,t){e.valueKey?i.add(t[e.valueKey]):i.add(t);i.$input.typeahead("val","")},i))}i.$container.on("click",n.proxy(function(){i.$element.attr("disabled")||i.$input.removeAttr("disabled");i.$input.focus()},i));if(i.options.addOnBlur&&i.options.freeInput)i.$input.on("focusout",n.proxy(function(){n(".typeahead, .twitter-typeahead",i.$container).length===0&&(i.add(i.$input.val()),i.$input.val(""))},i));i.$container.on("keydown","input",n.proxy(function(t){var r=n(t.target),u=i.findInputWrapper(),f,e,s,h;if(i.$element.attr("disabled")){i.$input.attr("disabled","disabled");return}switch(t.which){case 8:o(r[0])===0&&(f=u.prev(),f.length&&i.remove(f.data("item")));break;case 46:o(r[0])===0&&(e=u.next(),e.length&&i.remove(e.data("item")));break;case 37:s=u.prev();r.val().length===0&&s[0]&&(s.before(u),r.focus());break;case 39:h=u.next();r.val().length===0&&h[0]&&(h.after(u),r.focus())}var c=r.val().length,l=Math.ceil(c/5),a=c+l+1;r.attr("size",Math.max(this.inputSize,r.val().length))},i));i.$container.on("keypress","input",n.proxy(function(t){var r=n(t.target),u,f;if(i.$element.attr("disabled")){i.$input.attr("disabled","disabled");return}u=r.val();f=i.options.maxChars&&u.length>=i.options.maxChars;i.options.freeInput&&(s(t,i.options.confirmKeys)||f)&&(u.length!==0&&(i.add(f?u.substr(0,i.options.maxChars):u),r.val("")),i.options.cancelConfirmKeysOnEmpty===!1&&t.preventDefault());var e=r.val().length,o=Math.ceil(e/5),h=e+o+1;r.attr("size",Math.max(this.inputSize,r.val().length))},i));i.$container.on("click","[data-role=remove]",n.proxy(function(t){i.$element.attr("disabled")||i.remove(n(t.target).closest(".tag").data("item"))},i));i.options.itemValue===r.itemValue&&(i.$element[0].tagName==="INPUT"?i.add(i.$element.val()):n("option",i.$element).each(function(){i.add(n(this).attr("value"),!0)}))},destroy:function(){var n=this;n.$container.off("keypress","input");n.$container.off("click","[role=remove]");n.$container.remove();n.$element.removeData("tagsinput");n.$element.show()},focus:function(){this.$input.focus()},input:function(){return this.$input},findInputWrapper:function(){for(var t=this.$input[0],i=this.$container[0];t&&t.parentNode!==i;)t=t.parentNode;return n(t)}};n.fn.tagsinput=function(t,r,u){var f=[];return this.each(function(){var e=n(this).data("tagsinput"),o;e?t||r?e[t]!==undefined&&(o=e[t].length===3&&u!==undefined?e[t](r,null,u):e[t](r),o!==undefined&&f.push(o)):f.push(e):(e=new i(this,t),n(this).data("tagsinput",e),f.push(e),this.tagName==="SELECT"&&n("option",n(this)).attr("selected","selected"),n(this).val(n(this).val()))}),typeof t=="string"?f.length>1?f:f[0]:f};n.fn.tagsinput.Constructor=i;e=n("<div />");n(function(){n("input[data-role=tagsinput], select[multiple][data-role=tagsinput]").tagsinput()})})(window.jQuery);
/**
 * @preserve
 * bootpag - jQuery plugin for dynamic pagination
 *
 * Copyright (c) 2015 botmonster@7items.com
 *
 * Licensed under the MIT license:
 *   http://www.opensource.org/licenses/mit-license.php
 *
 * Project home:
 *   http://botmonster.com/jquery-bootpag/
 *
 * Version:  1.0.7
 *
 */
(function(n){n.fn.bootpag=function(t){function f(t,f){var h,y,c,l,a,p;f=parseInt(f,10);var e,s=i.maxVisible==0?1:i.maxVisible,y=i.maxVisible==1?0:1,v=Math.floor((f-1)/s)*s,o=t.find("li");i.page=f=f<0?0:f>i.total?i.total:f;o.removeClass(i.activeClass);e=f-1<1?1:i.leaps&&f-1>=i.maxVisible?Math.floor((f-1)/s)*s:f-1;i.firstLastUse&&o.first().toggleClass(i.disabledClass,f===1);h=o.first();i.firstLastUse&&(h=h.next());h.toggleClass(i.disabledClass,f===1).attr("data-lp",e).find("a").attr("href",r(e));y=i.maxVisible==1?0:1;e=f+1>i.total?i.total:i.leaps&&f+1<=i.total-i.maxVisible?v+i.maxVisible+y:f+1;c=o.last();i.firstLastUse&&(c=c.prev());c.toggleClass(i.disabledClass,f===i.total).attr("data-lp",e).find("a").attr("href",r(e));o.last().toggleClass(i.disabledClass,f===i.total);l=o.filter("[data-lp="+f+"]");a="."+[i.nextClass,i.prevClass,i.firstClass,i.lastClass].join(",.");l.not(a).length||(p=f<=v?-i.maxVisible:0,o.not(a).each(function(t){e=t+1+v+p;n(this).attr("data-lp",e).toggle(e<=i.total).find("a").html(e).attr("href",r(e))}),l=o.filter("[data-lp="+f+"]"));l.not(a).addClass(i.activeClass);u.data("settings",i)}function r(n){return i.href.replace(i.hrefVariable,n)}var u=this,i=n.extend({total:0,page:1,maxVisible:null,leaps:!0,href:"javascript:void(0);",hrefVariable:"{{number}}",next:"&raquo;",prev:"&laquo;",firstLastUse:!1,first:'<span aria-hidden="true">&larr;<\/span>',last:'<span aria-hidden="true">&rarr;<\/span>',wrapClass:"pagination",activeClass:"active",disabledClass:"disabled",nextClass:"next",prevClass:"prev",lastClass:"last",firstClass:"first"},u.data("settings")||{},t||{});return i.total<=0?this:(n.isNumeric(i.maxVisible)||i.maxVisible||(i.maxVisible=parseInt(i.total,10)),u.data("settings",i),this.each(function(){var h,s,o=n(this),t=['<ul class="',i.wrapClass,' bootpag">'],e;for(i.firstLastUse&&(t=t.concat(['<li data-lp="1" class="',i.firstClass,'"><a href="',r(1),'">',i.first,"<\/a><\/li>"])),i.prev&&(t=t.concat(['<li data-lp="1" class="',i.prevClass,'"><a href="',r(1),'">',i.prev,"<\/a><\/li>"])),e=1;e<=Math.min(i.total,i.maxVisible);e++)t=t.concat(['<li data-lp="',e,'"><a href="',r(e),'">',e,"<\/a><\/li>"]);i.next&&(s=i.leaps&&i.total>i.maxVisible?Math.min(i.maxVisible+1,i.total):2,t=t.concat(['<li data-lp="',s,'" class="',i.nextClass,'"><a href="',r(s),'">',i.next,"<\/a><\/li>"]));i.firstLastUse&&(t=t.concat(['<li data-lp="',i.total,'" class="last"><a href="',r(i.total),'">',i.last,"<\/a><\/li>"]));t.push("<\/ul>");o.find("ul.bootpag").remove();o.append(t.join(""));h=o.find("ul.bootpag");o.find("li").click(function(){var t=n(this),r;t.hasClass(i.disabledClass)||t.hasClass(i.activeClass)||(r=parseInt(t.attr("data-lp"),10),u.find("ul.bootpag").each(function(){f(n(this),r)}),u.trigger("page",r))});f(h,i.page)}))}})(jQuery,window);$(async function(){window.providersSelect=$("#unsynced-providers");window.brandsSelect=$("#unsynced-brands");window.syncedSpinner=$("#synced-loading");window.unsyncedSpinner=$("#unsynced-loading");await loadSearchSession();$(window).on("unload",saveSearchSession);$("#withStock").attr("checked",_searchSession.withStock);$("#withStock").click(function(){_searchSession.withStock=$(this).is(":checked")});$(`#${_searchSession.activeTab}`).click();initItemsPerPage();initUnsyncTabSelects();initSyncProductModal();initPagination();initFilterInputs();loadSyncedProducts(_searchSession.sPage);_searchSession.providerId!=null&&$("#unsynced-providers").val(_searchSession.providerId);await loadBrands();_searchSession.providerBrandId!=null&&$("#unsynced-brands").val(_searchSession.providerBrandId);loadUnsyncedProducts(_searchSession.uPage)});